+++
title = "Malware Analysis"
date = 2019-07-01
+++

Malware Analysis - CJ 407 [Summer 2019]

Teacher: Gary Warner

“Always use a VPN”, “Geeks, come here”

# Notes

---

Static Analysis - Looking through the code, never executing it. All options of code can be observed this way.

Dynamic Analysis - Monitoring of code and executing it.

Contextual Analysis - how the malware changes overtime (aka longitudinal studies) by infecting my own machine.

MacOS is just as vulnerable to malware as any other operating system. The reason people think differently is because Windows is the most common OS for any corporation and that’s where hackers get the most money from.

- Dropper
  - Part of malware that will go to the internet and download either more malware or an update for current version.
  - “Goes and gets rest of/more code”
- Using a Virtual Machine
  - Has a “Sandbox” nature
  - Can lock and unlock hard drive
  - Newer malware can see if your using a VM and break into your host OS…
- Virus
  - Code that finds & enters other code (executables) on a machine and executes it.
  - Must put itself into another piece of code to be a virus.

Hashes

- A unique code that gives a file a special string
- Popular examples include SHA1, SHA256, and MD5

Malware used to be something to try for fun --”can I do it?”. Today it’s obviously more financially motivated. Malware can be pushed via bluetooth or LAN

---

- 3 things to monitor when doing malware analysis
  - Memory
  - Network
  - Disk (files and the registry)

The standard password is infected

Registry - hierarchical database that stores configuration settings and options for WINDOWS. Contains settings for low-level operating system components and applications that decided to use the registry (almost all).
The registry equivalent for MacOS are things called, “.plist files”.

The Windows Registry file that stores programs that run at boot up

- HKey_Local_Machine\everyone\Microsoft\Windows\Current Version\run

Keep computer safe when dealing with malware

- Take extensions off executables
- Disconnect from network
- Make sure device is immutable

How to get samples into your vm

- Devices ->shared folder -> other -> browse to thumb drive (or wherever the malware is stored)

_TOOLS:_

- IDA
  - Interactive disassembler - shows code for static analysis
- Wireshark
  - Monitor for network protocols and packets
- Fiddler
  - Decrypts https traffic; creates “man in the middle” certificates between you and the server. To your web browser, fiddler claims to be the secure web server, and to the web server, Fiddler mimics the web browser. It must dynamically generate https certificates to pretend to be the web server. **Fiddler isn’t a trusted root certificate authority,** so your browser will see this and prevent traffic unless allowed.
- Procmon
  - Looks for changes in the registry and files
- OllyDbg
  - For dynamic analysis, steps through code line by line.

---

- **IOC -** Indicator of Compromise
  - Firewall logs (ip address/url), registry keys, hash of malware file (check hash in all computers), and file names.
  - IOC is only helpful when you have a mechanism to identify it in the network (log all traffic).
  - Most companies don’t log ip addresses that are allowed by the firewall. This isn’t smart, it is necessary to log everything.

VirtualBox Network tools

**Network Address Translation (NAT)** - translates the IP addresses of computers in a local network to a single IP address.

**Bridged**- connects through the host to whatever is your default network device that allocates IP addresses for your physical network

(Not that important, but cool):
What a firewall command would look like…

| Source | Dest       | Port | Action |
| ------ | ---------- | ---- | ------ |
| own ip | website ip | 443  | Deny   |

- **TCP**
  - Longer connection than UDP
  - A new TCP number means new connection -> Follow TCP Stream
- **UDP**
  - UDP is a connectionless protocol. Meaning, data at one end transmits to the other without even checking if the device is ready or available to recieve.
  - Examples include: A video conference, DHCP & DNS
- **DNS**
  - Domain Name System. DNS filter will show all traffic to and from domains.

**Homework**: Use wireshark and fiddler. Follow a new TCP stream

---

- **UPX Packing**
  - UPX packing hides from anti viruses
  - EP (entry point) is normally where it is.
  - Packing hides import table (DLL & function calls) and strings.

If all the files have the same capabilities (Function calls), normally means they’re apart of the same malware families.

- Strings
  - Possibly a website address where data is sent
  - Author names/persons involved will be found in import strings
  - Unique url strings indicate malware came from somewhere else; not the same author.
- Antivirus Detection
  - Put file in PeStudio and look what type of malware Antivirus programs call it.

Malware will terminate if it sees nothing in the internet cache --normally this means someone is running it on a VM.

- **Process Termination**
  - Look for an anti virus start up in the registry and kill it.
  - Could also kill a child malware running and run another one.

---

- **Persistence**
  - Reinfect the same box (whether actual computer or VM)
  - Two types: **Local** and **Infrastructure**
    - Local persistence writes into registry, meaning a relaunch will start malware again.
    - Infrastructure persistence is the Conficker story. The program used DGA and RPC which let bots handle persistence.

**Conficker**, or DownAdUp, was a malware that took advantage of a microsoft vulnerability.
RPC - (Remote Procedure call) Communicate with other windows machines in the network and take complete control of them. White hat hackers thought to close TCP 139 and 445 which would deny any communication to a windows network. Wasn’t practical because printers, fax machines etc still needed to connect.
DGA - (Domain Generation algorithm) Malware will constantly generate calculated domain names --some that won’t even exist yet. Some time in the future, the author will register the domain and all the infected machines will go to it.

Bots operate on one (could have 2 or 3 as back ups) ip address --called “command and control”. If that is killed or malware doesn’t have it, they will rely on DGA and go to remote server.

---

Benefits of snapshots

- Helps step through analyzing malware (starting and stopping when needed).
- Able to save a place in the virtual machine that you may want to come back to in the future in case you break something.

One tactic after finding the IOC is to identify where it’s being hosted and request a blocker to be put on the ip by the webhosting company.

This can also be a tactic for **Sinkholing** a Domain: redirect all traffic to our machine so we can get a list of infected nodes.

Domain registrar can also reset the password to account and take away all DNS settings.

**Review**

An argument for running malware in normal mode is that you can see if it is persistent unlike immutable mode that would not show you if the malware was persistent.

TrickBot - banking trojan
Kelihost - pishing email sent out during christmas. Was a dropper
Conficker - First instance of DGAs; microsoft vulnerabilities
FakeAntivirus - if fake anti virus ran, someone got paid

IDA pro is a static analysis tool.

Entry point- where the malware enters a program

UPX-Ultimate packer for executables

MSDN Library - tells you what the function calls do from Microsoft Dlls

Key DLLS

- Wininet.dll-all internet activity
- User32.dll-interacting with mouse, keyboard and windows on screen
- Kernel32.dll-almost all file, memory and running process operations
- Wsock32.dll- older internet activity
- Advapi32.dll- most

**Articles that we find interesting or helpful**

<https://www.infosecurity-magazine.com/opinions/malware-detection-signatures/>

<https://twitter.com/VK_Intel/status/1144663481117020162>

<https://www.fiddlerbook.com/fiddler/help/httpsdecryption.asp>
